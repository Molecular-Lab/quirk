import { Hex } from "viem"
import { expect, it } from "vitest"

import { ArkenQuoteResponse, ArkenTradeRouteStruct } from "@rabbitswap/api-core/client/arken-client/dto"

import { prepareSwapData } from "./mapper"
import { HermesResponse, mapPriceUpdateData } from "./pyth-network-price"

const expectedCallData: Hex =
	"0xfa7f8583000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000fd0288aaae91eaf935e2ec14b23486f86516c8c000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000003e40267da6edf340000000000000000000000004e0bd60324971ad1cbc177c0c5c1aba890d8fda900000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000194ccfc49c3ebc7457e0b41b9c6b840c22f59850000000000000000000000003273c19716b2f4e95b563a099923e539c5aef1b30000000000000000000000000fd0288aaae91eaf935e2ec14b23486f86516c8c000000000000000000000000c054751bdbd24ae713ba3dc9bd9434abe2abc1ce000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005f5e10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000026f7000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000653504e41550100000003b801000000040d00f0d4c48ac2e935e586d2e9604ac969c2e034d7587df65c1769f4b2797a08f0f43902d2f02b67c2c06c9b7e5d701652b4122be05b120c21692013cff92e1139230002e05a7968f662924cfa8f81cc0dcec109498dc7d2e2363cad8348b32dc9b39b451d6081cec52b30589455ca631bb99748f891da8b4894f1a3ee362c50cba366d30003523a448dfbecc151a9eedf666dda6f920203deed695e7a970045b4792bfb4d486b922d493a04e1ab2eddfa10f44d54a132ddccbebd543f40b110886bf7e7de43010448fc0869534c35b9b0923e95880b47c654099f2be580988d8a451570463bd8495259146647e8ab1dc80dc716ea18f1de8c9d137ce58d8ca5cdfab6f7e8fb70e10106560e28717fadb1633c43e66a798ef4048073f66ab4462f2b2593691d512ab9db53cdc6e2791ed269dce651028fbeb6e9e389855607c74a66ea097425afae707d0008d1b4b0fa1dcd4073a784af4ad3f136843d77e2e6708102617a04e3a3dce3110123ffdb88e01afe22e3de1d7483391857d875100ee2e9a85e29b807050f134cc3000bf081d788c6247f489003cef02c06f6641788c29beceb2470cdab734226e405bf4649c8685dc69b08c4ad8aefab8463ade794890260b3a9b646995de411f29697010c92fdef2c5af1ea069a912ece0faaebb872161114179fdbfd359a1cf03d84b6645d68a417c75ae9c0070a02b867c1f58dea658f75d8d5bb0b2c690e4ed13369d1000d471734713f3b7247b0fd8ffcd9be67ede0797e0bc044ef2a72a9cc379c09fd2324f58ddf9e707afc4eee976c683892351d77229ec66e567ce65d3ccff4fe5581000e07a8fe4f494a95f801e5657e87f3e86e4ddde3b3c4d7fdb47eefeccd0d77cecb483b52e36bfcc779b75c4d2022468dd30608d0965fec6f2f9e0352545611c4e1010f4937a8cff85f7d70863de4b6284fc69c6619f974cdd9ba44aec8f2268d2e7d8852933d1a0615b983f2424a3b4b5445b87b6896287033d330640bfacdb7b251af0110125016e9483d9faad20d143abdd6e912e8e5676ccf541659b828e7d29578756e20f6daaec6e0b0b0b1360854f775718def70f644b574bb143e8dcfef0588dfe601119a24484cf6ceabcd28cc7734b54cae0c5b5414009065402d755772e45b6989e45339fa2da525011f4d59080d078e9df81fb52893be3c185b23ad28e3c3b617aa006846b85700000000001ae101faedac5851e32b9b23b5f9411a8c2bac4aae3ed4dd7b811dd1a72ea4aa71000000000832960c014155575600000000000d401e2c0000271054c2002a9ee35b42a15a0792ab34d63d3f15522902005500f80ba6864e3f1b36c873bcb2767079d5fb86cf04855e714b2a0f30d7e0830a2400000000010adbf900000000000069aefffffff8000000006846b857000000006846b8570000000001081ade0000000000006a5c0c5bb2501819cb66a6a1c0f3be32b5fe4048261ba312d6cfa95ed1674c6d9843343d1e73ada4a9f92a6530b0a6752e5f900d9e3ec4df5bf5c78f6806225118309b0babecf49d390dfe5bd9e0878b76e299d618aae1ec540423dc1798c26dc3cb24dc0c991153028b33fe61a8fa0e7ede453fd1fdfacbeedb733f383ada49426a0e929224057c39796f0b231a7a41b073c4497e4d559891ecbad85f4587971f76d8e7e330df7cd8074d0f4880632f1b1ad778b5ebdaed85d70ef353e256755ccf35b77880f14051059bd10019f319d66312d63504e38a163aee2e3cabd959ba1caa23535ca2383d9aca768b77759ffb73150055002dd14c7c38aa7066c7a508aac299ebcde5165b07d5d9f2d94dfbfe41f0bc5f2e00000000004bcaf90000000000002859fffffff8000000006846b857000000006846b85700000000004afe9200000000000027cd0ca295e916b12ffd5e385c200ddcd0ef3efa2ed68cb311656ce33b5778787e3e8a2a50f9ce428de45541fbbd5c3122f168d8d5511dcf0671bc9a6a7b4bf2e3290116bda8efdfb64e6d7540578866f27a9a8c6bbd9139d511fffef6767cf1bb940af1912fa5ad4b98638c4d1d57f254f72b67f4418e36c04ccf8f856ea36fc6412e375d2811afc141cd1aee764131433cddd476224a997e1972580dea5f96798493863660441986bd5785060ed42d701252556811bd0e60abfa9cc9282e1245dc93264338115601c61bf336c4c03014422f651a7573f633d5703574c44959ba1caa23535ca2383d9aca768b77759ffb731500000000000000000000000000"

const hermesResponse: HermesResponse = {
	binary: {
		encoding: "base64",
		data: [
			"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",
		],
	},
	parsed: [
		{
			id: "f80ba6864e3f1b36c873bcb2767079d5fb86cf04855e714b2a0f30d7e0830a24",
			price: {
				price: "17488889",
				conf: "27054",
				expo: -8,
			},
		},
		{
			id: "2dd14c7c38aa7066c7a508aac299ebcde5165b07d5d9f2d94dfbfe41f0bc5f2e",
			price: {
				price: "4967161",
				conf: "10329",
				expo: -8,
			},
		},
	],
}
const priceUpdateData: Buffer[][] = mapPriceUpdateData(hermesResponse)

const arkenQuoteResponse: ArkenQuoteResponse = {
	fromToken: "0x0fd0288aaae91eaf935e2ec14b23486f86516c8c",
	toToken: "0xc054751bdbd24ae713ba3dc9bd9434abe2abc1ce",
	fromTokenAmount: "1000000000000000000",
	toTokenAmount: "283183557447878388",
	toTokenAmountWithoutArkenFee: "283467004456125434",
	isSourceFee: true,
	isRouterSource: true,
	priceImpact: "0",
	arkenFee: "283447008247046",
	transactionFee: "56250000000000",
	protocols: [
		[
			{
				chain: "viction",
				dexName: "brownfi",
				part: 100,
				partPool: 100,
				fromTokenAddress: "0x0fd0288aaae91eaf935e2ec14b23486f86516c8c",
				toTokenAddress: "0xc054751bdbd24ae713ba3dc9bd9434abe2abc1ce",
				fromRouterAddress: "0x0000000000000000000000000000000000000000",
				toRouterAddress: "0x0000000000000000000000000000000000000000",
				lpAddress: "0x3273c19716b2f4e95b563a099923e539c5aef1b3",
				updatedAt: 1749465161,
				updatedBlock: 94879272,
				fee: 9975,
			},
		],
	],
	isOutSide: false,
	pyth: [
		{
			updatedData:
				"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",
			updateFee: "1",
			baseTokenPriceId: "f80ba6864e3f1b36c873bcb2767079d5fb86cf04855e714b2a0f30d7e0830a24",
			quoteTokenPriceId: "2dd14c7c38aa7066c7a508aac299ebcde5165b07d5d9f2d94dfbfe41f0bc5f2e",
		},
	],
}

const tradeRoutes: ArkenTradeRouteStruct[] = [
	{
		routerAddress: "0x0194ccfc49c3ebc7457e0b41b9c6b840c22f5985",
		lpAddress: "0x3273c19716b2f4e95b563a099923e539c5aef1b3",
		fromToken: "0x0fd0288aaae91eaf935e2ec14b23486f86516c8c",
		toToken: "0xc054751bdbd24ae713ba3dc9bd9434abe2abc1ce",
		from: "0x0000000000000000000000000000000000000000",
		to: "0x0000000000000000000000000000000000000000",
		part: 100000000,
		direction: 0,
		fromTokenIndex: 0,
		toTokenIndex: 0,
		amountAfterFee: 9975,
		dexInterface: 16,
	},
]

const recipient = "0x4E0BD60324971Ad1Cbc177C0C5c1ABA890d8FDA9"

it("parse call data", () => {
	const {
		methodParams: { data: callData },
	} = prepareSwapData(arkenQuoteResponse, priceUpdateData[0], tradeRoutes, {
		isSrcNative: false,
		isDestNative: true,
		recipient: recipient,
		slippage: 1, // 1%
	})

	expect(callData.length, "output length").toEqual(expectedCallData.length)

	// test for actual encoded data
	expect(callData.toString().toLowerCase(), "actual data").toBe(expectedCallData.toString().toLowerCase())
})
