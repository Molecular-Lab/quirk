# API Key Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FLOW 1: Client Registration                          â”‚
â”‚                     (Product Owner Creates Organization)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frontend (APITestingPage.tsx)                Backend (b2b-api)
         â”‚                                            â”‚
         â”‚  POST /api/v1/clients                     â”‚
         â”‚  {                                         â”‚
         â”‚    companyName: "GrabPay",                 â”‚
         â”‚    walletType: "MANAGED",                  â”‚
         â”‚    vaultsToCreate: "both"                  â”‚
         â”‚  }                                         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ client.router  â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ client.usecase â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 1. Generate:   â”‚
         â”‚                                    â”‚   apiKey =     â”‚
         â”‚                                    â”‚   "prod_pk_7a9fâ”‚
         â”‚                                    â”‚   3e2b..."     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 2. Hash:       â”‚
         â”‚                                    â”‚   hash =       â”‚
         â”‚                                    â”‚   bcrypt(key)  â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 3. Extract:    â”‚
         â”‚                                    â”‚   prefix =     â”‚
         â”‚                                    â”‚   "prod_pk_"   â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚   Database     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ INSERT INTO    â”‚
         â”‚                                    â”‚ client_orgs:   â”‚
         â”‚                                    â”‚  api_key_hash  â”‚
         â”‚                                    â”‚  api_key_prefixâ”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚  Response:                                 â”‚
         â”‚  {                                         â”‚
         â”‚    productId: "prod_abc123",              â”‚
         â”‚    api_key: "prod_pk_7a9f3e2b..."  â—„â”€â”€â”€â”€â”€â”€â”¤
         â”‚  }                                         â”‚
         â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                            â”‚
         â”‚ ğŸ“¦ Auto-Save to localStorage               â”‚
         â”‚    localStorage.setItem(                   â”‚
         â”‚      "b2b:api_key",                        â”‚
         â”‚      "prod_pk_7a9f3e2b..."                 â”‚
         â”‚    )                                       â”‚
         â”‚                                            â”‚
         â”‚ âœ… API Key Ready for FLOW 3-9              â”‚
         â”‚                                            â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FLOW 3: Create End-User (Authenticated)                 â”‚
â”‚                   (Product Owner Creates Driver/Customer Account)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frontend (APITestingPage.tsx)                Backend (b2b-api)
         â”‚                                            â”‚
         â”‚ ğŸ“¤ Auto-Inject x-api-key Header            â”‚
         â”‚    (axios interceptor)                     â”‚
         â”‚                                            â”‚
         â”‚  POST /api/v1/users                        â”‚
         â”‚  Headers:                                  â”‚
         â”‚    x-api-key: "prod_pk_7a9f3e2b..."        â”‚
         â”‚  Body:                                     â”‚
         â”‚  {                                         â”‚
         â”‚    clientId: "prod_abc123",                â”‚
         â”‚    clientUserId: "driver_001",             â”‚
         â”‚    email: "driver@example.com"             â”‚
         â”‚  }                                         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ Express        â”‚
         â”‚                                    â”‚ Middleware     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ CORS Check     â”‚
         â”‚                                    â”‚ âœ… x-api-key   â”‚
         â”‚                                    â”‚    allowed     â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ apiKeyAuth     â”‚
         â”‚                                    â”‚ middleware     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 1. Extract:    â”‚
         â”‚                                    â”‚   header       â”‚
         â”‚                                    â”‚   x-api-key    â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 2. Format:     â”‚
         â”‚                                    â”‚   regex check  â”‚
         â”‚                                    â”‚   /prod_pk_/   â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 3. Prefix:     â”‚
         â”‚                                    â”‚   lookup in DB â”‚
         â”‚                                    â”‚   (fast O(1))  â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 4. Verify:     â”‚
         â”‚                                    â”‚   bcrypt       â”‚
         â”‚                                    â”‚   compare      â”‚
         â”‚                                    â”‚   (secure)     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 5. Check:      â”‚
         â”‚                                    â”‚   isActive     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 6. Attach:     â”‚
         â”‚                                    â”‚   req.client   â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ user.router    â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ user.usecase   â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 1. Resolve:    â”‚
         â”‚                                    â”‚   prod_abc123  â”‚
         â”‚                                    â”‚   â†’ UUID       â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 2. Create:     â”‚
         â”‚                                    â”‚   end_user     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 3. Auto-create:â”‚
         â”‚                                    â”‚   10 vaults    â”‚
         â”‚                                    â”‚   (5 chains Ã—  â”‚
         â”‚                                    â”‚    2 tokens)   â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚   Database     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ INSERT INTO    â”‚
         â”‚                                    â”‚ end_users      â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ INSERT INTO    â”‚
         â”‚                                    â”‚ end_user_vaultsâ”‚
         â”‚                                    â”‚ (10 rows)      â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚  Response (200 OK):                        â”‚
         â”‚  {                                         â”‚
         â”‚    id: "uuid...",                          â”‚
         â”‚    userId: "driver_001",                   â”‚
         â”‚    vaults: [...]                  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  }                                         â”‚
         â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                            â”‚
         â”‚ âœ… User Created                            â”‚
         â”‚ âœ… 10 Vaults Ready                         â”‚
         â”‚                                            â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ERROR CASE: Invalid API Key                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frontend                                      Backend
         â”‚                                            â”‚
         â”‚  POST /api/v1/users                        â”‚
         â”‚  Headers:                                  â”‚
         â”‚    x-api-key: "invalid_key_123"            â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                                            â”‚
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ apiKeyAuth     â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 1. Format:     â”‚
         â”‚                                    â”‚   âŒ Regex     â”‚
         â”‚                                    â”‚      failed    â”‚
         â”‚                                    â”‚                â”‚
         â”‚                                    â”‚ 2. Response:   â”‚
         â”‚                                    â”‚   401 Invalid  â”‚
         â”‚                                    â”‚   API key      â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚  Response (401):                           â”‚
         â”‚  {                                         â”‚
         â”‚    error: "Invalid API key format",        â”‚
         â”‚    hint: "API key must be               â—„â”€â”€â”¤
         â”‚           {env}_pk_{32hex}"                â”‚
         â”‚  }                                         â”‚
         â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                            â”‚
         â”‚ âŒ Request Blocked                         â”‚
         â”‚                                            â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Security Architecture                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API Key Lifecycle                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. GENERATION (FLOW 1)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ generateApiKey(isSandbox)                                   â”‚
   â”‚ â”œâ”€ crypto.randomBytes(16) â†’ 32 hex chars                    â”‚
   â”‚ â”œâ”€ Prefix: "prod_pk_" or "test_pk_"                         â”‚
   â”‚ â””â”€ Output: "prod_pk_7a9f3e2b1c4d8f6e5a0b9c8d7e6f5a4b"       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. HASHING (Storage)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ hashApiKey(apiKey)                                          â”‚
   â”‚ â”œâ”€ bcrypt.hash(apiKey, 10 salt rounds)                      â”‚
   â”‚ â””â”€ Hash: "$2b$10$N9qo8uL..." (60 chars)                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. PREFIX EXTRACTION (Fast Lookup)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ extractPrefix(apiKey)                                       â”‚
   â”‚ â”œâ”€ Take first 8 chars                                       â”‚
   â”‚ â””â”€ Prefix: "prod_pk_"                                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. VALIDATION (FLOW 3-9)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Step 1: Regex Check (Fast)                                 â”‚
   â”‚   /^(prod|test)_pk_[a-f0-9]{32}$/                          â”‚
   â”‚   â”œâ”€ Valid: Continue                                        â”‚
   â”‚   â””â”€ Invalid: Reject 401                                    â”‚
   â”‚                                                             â”‚
   â”‚ Step 2: Prefix Lookup (O(1))                               â”‚
   â”‚   SELECT * FROM client_organizations                       â”‚
   â”‚   WHERE api_key_prefix = 'prod_pk_'                        â”‚
   â”‚   â”œâ”€ Found: Continue                                        â”‚
   â”‚   â””â”€ Not Found: Reject 401                                  â”‚
   â”‚                                                             â”‚
   â”‚ Step 3: Bcrypt Compare (Constant-Time)                     â”‚
   â”‚   bcrypt.compare(apiKey, storedHash)                       â”‚
   â”‚   â”œâ”€ Match: Continue                                        â”‚
   â”‚   â””â”€ No Match: Reject 401                                   â”‚
   â”‚                                                             â”‚
   â”‚ Step 4: Active Status Check                                â”‚
   â”‚   client.isActive === true                                 â”‚
   â”‚   â”œâ”€ Active: Allow Request                                 â”‚
   â”‚   â””â”€ Inactive: Reject 403                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Protected Endpoints                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… /api/v1/users*           (FLOW 3: Create/List End-Users)
âœ… /api/v1/deposits*        (FLOW 4: Initiate/Complete Deposits)
âœ… /api/v1/withdrawals*     (FLOW 8: Request Withdrawals)
âœ… /api/v1/vaults*          (FLOW 5,7,9: Balance/Yield/List)

âŒ /api/v1/clients          (FLOW 1: Public Registration)
âŒ /health                  (Health Check)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Data Flow Summary                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Registration â†’ Generation â†’ Hashing â†’ Storage â†’ Return (Once!)
                   â†“
            "prod_pk_7a9f..."
                   â†“
         bcrypt(key) â†’ Hash
                   â†“
         Database: api_key_hash + api_key_prefix
                   â†“
         Response: { api_key: "prod_pk_..." }
                   â†“
         Frontend: localStorage.setItem()
                   â†“
         Future Requests: x-api-key header
                   â†“
         Validation: Prefix â†’ Bcrypt â†’ Active Check
                   â†“
         Authorized: req.client = { id, productId, ... }


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Multi-Organization Safety                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Same Privy User â†’ Multiple Organizations â†’ Isolated API Keys

Privy User: did:privy:abc123
    â”‚
    â”œâ”€ GrabPay Organization
    â”‚  â””â”€ API Key: prod_pk_7a9f3e2b... (unique bcrypt hash)
    â”‚  â””â”€ Vaults: 10 vaults (5 chains Ã— 2 tokens)
    â”‚  â””â”€ Users: driver_001, driver_002, ...
    â”‚
    â”œâ”€ GrabFood Organization
    â”‚  â””â”€ API Key: prod_pk_1c2d3e4f... (different hash)
    â”‚  â””â”€ Vaults: 10 vaults (5 chains Ã— 2 tokens)
    â”‚  â””â”€ Users: restaurant_001, ...
    â”‚
    â””â”€ GrabMart Organization
       â””â”€ API Key: prod_pk_9e0f1a2b... (different hash)
       â””â”€ Vaults: 10 vaults (5 chains Ã— 2 tokens)
       â””â”€ Users: shopper_001, ...

Each API key grants access to ONLY that organization's resources!
```

---

## ğŸ¯ Status Summary

âœ… **API Key Generation** - Working  
âœ… **bcrypt Hashing** - 10 salt rounds  
âœ… **Frontend Auto-Save** - localStorage  
âœ… **Frontend Auto-Inject** - x-api-key header  
âœ… **Backend Validation** - Prefix + bcrypt + active check  
âœ… **Protected Routes** - FLOW 3-9 require authentication  
âœ… **ProductId Resolution** - prod_abc123 â†’ UUID  
âœ… **Multi-Org Isolation** - Separate API keys per org  
âœ… **Build Success** - No TypeScript errors  

â³ **Next**: Testing (Phase 6) â†’ Deposits (Phase 7) â†’ Withdrawals (Phase 8)
