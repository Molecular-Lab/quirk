# @proxify/database

Type-safe database queries generated by SQLC.

## üìÇ Structure

```
packages/database/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ gen/              # Auto-generated by sqlc
‚îÇ       ‚îú‚îÄ‚îÄ client_sql.ts
‚îÇ       ‚îú‚îÄ‚îÄ deposit_sql.ts
‚îÇ       ‚îú‚îÄ‚îÄ withdrawal_sql.ts
‚îÇ       ‚îú‚îÄ‚îÄ vault_sql.ts
‚îÇ       ‚îú‚îÄ‚îÄ defi_sql.ts
‚îÇ       ‚îú‚îÄ‚îÄ end_user_sql.ts
‚îÇ       ‚îî‚îÄ‚îÄ audit_sql.ts
‚îî‚îÄ‚îÄ package.json
```

## üöÄ How to Use

### 1. Install Dependencies

```bash
npm install postgres  # PostgreSQL client
```

### 2. Import Generated Functions

```typescript
import postgres from 'postgres';
import { 
  getClient, 
  createClientOrganization,
  type GetClientArgs,
  type CreateClientOrganizationArgs
} from '@proxify/database/gen/client_sql';

import {
  getDeposit,
  createDepositTransaction,
  type GetDepositArgs
} from '@proxify/database/gen/deposit_sql';
```

### 3. Setup Database Connection

```typescript
// Create connection
const sql = postgres({
  host: 'localhost',
  port: 5432,
  database: 'proxify_dev',
  username: 'proxify_user',
  password: 'proxify_password'
});
```

### 4. Use Type-Safe Queries

```typescript
// ‚úÖ Get a client by ID
const client = await getClient(sql, { id: 'client-uuid' });
if (client) {
  console.log(client.companyName);  // Type-safe!
  console.log(client.productId);
}

// ‚úÖ Create a new client
const newClient = await createClientOrganization(sql, {
  productId: 'grab_sg_001',
  companyName: 'Grab Singapore',
  businessType: 'ride_hailing',
  walletType: 'custodial',
  walletManagedBy: 'proxify',
  privyOrganizationId: 'privy_org_123',
  privyWalletAddress: '0x1234...',
  apiKeyHash: 'hashed_key',
  apiKeyPrefix: 'pk_live_',
  endUserYieldPortion: '95.00',
  platformFee: '1.00',
  performanceFee: '10.00',
  isActive: true,
  isSandbox: false
});

// ‚úÖ Get deposit transaction
const deposit = await getDeposit(sql, { id: 'deposit-uuid' });
if (deposit) {
  console.log(`Amount: $${deposit.fiatAmount}`);
  console.log(`Status: ${deposit.status}`);
}
```

## üìù Available Query Files

| File | Description | Key Functions |
|------|-------------|---------------|
| `client_sql.ts` | Client organization queries | `getClient`, `createClientOrganization`, `updateClientRiskTier` |
| `deposit_sql.ts` | Deposit transactions | `getDeposit`, `createDepositTransaction`, `listUserDeposits` |
| `withdrawal_sql.ts` | Withdrawal transactions | `getWithdrawal`, `createWithdrawalRequest`, `processWithdrawal` |
| `vault_sql.ts` | Vault & index management | `getVaultIndex`, `updateVaultIndex`, `calculateUserShares` |
| `defi_sql.ts` | DeFi allocations | `listDefiAllocations`, `createDefiAllocation` |
| `end_user_sql.ts` | End user operations | `getEndUser`, `createEndUser`, `getUserBalance` |
| `audit_sql.ts` | Audit logging | `createAuditLog`, `listAuditLogs` |

## üîß Example: Repository Implementation

```typescript
// packages/core/repository/client.repository.ts
import postgres, { Sql } from 'postgres';
import { 
  getClient, 
  createClientOrganization,
  type GetClientArgs,
  type CreateClientOrganizationArgs,
  type CreateClientOrganizationRow
} from '@proxify/database/gen/client_sql';

export class ClientRepository {
  constructor(private sql: Sql) {}

  async findById(id: string): Promise<ClientOrganization | null> {
    const row = await getClient(this.sql, { id });
    if (!row) return null;

    // Map database row to domain entity
    return {
      id: row.id,
      productId: row.productId,
      companyName: row.companyName,
      businessType: row.businessType,
      walletType: row.walletType,
      privyOrganizationId: row.privyOrganizationId,
      isActive: row.isActive,
      createdAt: row.createdAt,
      updatedAt: row.updatedAt
    };
  }

  async create(params: CreateClientParams): Promise<ClientOrganization> {
    const row = await createClientOrganization(this.sql, {
      productId: params.productId,
      companyName: params.companyName,
      businessType: params.businessType,
      walletType: params.walletType,
      walletManagedBy: params.walletManagedBy,
      privyOrganizationId: params.privyOrganizationId,
      privyWalletAddress: params.privyWalletAddress,
      apiKeyHash: params.apiKeyHash,
      apiKeyPrefix: params.apiKeyPrefix,
      endUserYieldPortion: params.endUserYieldPortion.toString(),
      platformFee: params.platformFee?.toString() || '0',
      performanceFee: params.performanceFee?.toString() || '0',
      isActive: params.isActive ?? true,
      isSandbox: params.isSandbox ?? false
    });

    return this.mapToEntity(row);
  }
}
```

## üéØ Integration with Your Repository Layer

### Before (Stubbed):
```typescript
export class ClientOrganizationRepository {
  async create(params: CreateClientParams): Promise<ClientOrganization> {
    throw new Error('Not implemented - awaiting sqlc generation')
  }
}
```

### After (Using Generated Code):
```typescript
import { createClientOrganization } from '@proxify/database/gen/client_sql';

export class ClientOrganizationRepository {
  constructor(private sql: Sql) {}

  async create(params: CreateClientParams): Promise<ClientOrganization> {
    const row = await createClientOrganization(this.sql, {
      productId: params.productId,
      companyName: params.companyName,
      // ... map all fields
    });
    return this.mapToEntity(row);
  }
}
```

## üîÑ Regenerating Code

When you modify SQL queries in `database/queries/*.sql`:

```bash
# Regenerate TypeScript and Go code
make sqlc-generate

# Or manually
sqlc generate
```

## üß™ Testing Queries

```typescript
import postgres from 'postgres';
import { getClient } from '@proxify/database/gen/client_sql';

const sql = postgres('postgresql://proxify_user:proxify_password@localhost:5432/proxify_dev');

// Test a query
const client = await getClient(sql, { id: 'test-id' });
console.log(client);

// Close connection
await sql.end();
```

## üìö Type Safety Benefits

1. **Compile-time checks**: TypeScript catches errors before runtime
2. **Autocomplete**: Your IDE suggests available fields
3. **Refactoring safety**: Renaming columns updates all usages
4. **No SQL injection**: Parameterized queries by default

## üõ†Ô∏è Common Patterns

### Pattern 1: Transaction Support
```typescript
await sql.begin(async (tx) => {
  const client = await createClientOrganization(tx, { ... });
  const vault = await createVaultIndex(tx, { clientId: client.id, ... });
  // Both or none
});
```

### Pattern 2: Error Handling
```typescript
try {
  const client = await getClient(sql, { id });
  if (!client) {
    throw new Error('Client not found');
  }
  return client;
} catch (error) {
  logger.error('Database error:', error);
  throw error;
}
```

### Pattern 3: Mapping to Domain Entities
```typescript
class ClientMapper {
  static toDomain(row: GetClientRow): ClientOrganization {
    return {
      id: row.id,
      productId: row.productId,
      companyName: row.companyName,
      // ... map all fields
    };
  }
}
```

## üöÄ Next Steps

1. Update `packages/core/repository/*.ts` to use generated queries
2. Replace `Database = any` with actual postgres `Sql` type
3. Implement repository methods using generated functions
4. Add integration tests with test database
