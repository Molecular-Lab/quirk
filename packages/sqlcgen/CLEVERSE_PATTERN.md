# ğŸ¨ Cleverse TypeScript Pattern with SQLC

This document explains how we use SQLC-generated TypeScript code with the **Cleverse architecture pattern** for production-grade type safety and clean separation of concerns.

## ğŸ“Š Architecture Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      React Components                       â”‚
â”‚                   (UserBalance.tsx)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      React Hooks                            â”‚
â”‚                 (useUserBalance.ts)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Routes                             â”‚
â”‚              (app/api/deposits/route.ts)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Service Layer                             â”‚
â”‚       (DepositService, WithdrawalService, YieldService)     â”‚
â”‚       â€¢ Orchestrates multiple repositories                  â”‚
â”‚       â€¢ Implements complex business workflows               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Repository Layer                           â”‚
â”‚    (VaultRepository, ClientRepository, DepositRepository)   â”‚
â”‚    â€¢ Wraps SQLC-generated queries                          â”‚
â”‚    â€¢ Adds business logic (BigNumber calculations)          â”‚
â”‚    â€¢ Manages transactions                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SQLC Generated Layer                           â”‚
â”‚          (packages/database/src/gen/*.ts)                   â”‚
â”‚          â€¢ Type-safe query functions                        â”‚
â”‚          â€¢ Auto-generated from SQL                          â”‚
â”‚          â€¢ DON'T EDIT MANUALLY                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PostgreSQL                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Layer Responsibilities

### 1. SQLC Generated Layer (Auto-generated)

**Location:** `packages/database/src/gen/`

**Don't edit!** This is auto-generated by `make sqlc-generate`.

```typescript
// AUTO-GENERATED by SQLC
export interface ClientVault {
  id: string;
  clientId: string;
  currentIndex: string;  // NUMERIC(78,0) as string
  totalShares: string;
  // ... more fields
}

export async function getClientVaultByToken(
  sql: Sql,
  args: { clientId: string; chain: string; tokenAddress: string }
): Promise<ClientVault | null> {
  // Type-safe query execution
}
```

**What it provides:**
- âœ… TypeScript interfaces for all tables
- âœ… Type-safe query functions
- âœ… Parameter validation
- âœ… Return type safety

### 2. Repository Layer (Your Business Logic)

**Location:** `packages/database/src/repositories/`

**You write this!** Wraps SQLC with business logic.

```typescript
// YOUR CODE
export class VaultRepository {
  constructor(private readonly sql: Sql) {}

  async depositWithShareMinting(
    userId: string,
    amount: string
  ): Promise<{ shares: string }> {
    return await this.sql.begin(async (tx) => {
      // 1. Use SQLC queries or raw SQL
      const vault = await tx`SELECT * FROM client_vaults FOR UPDATE`;
      
      // 2. Add business logic (BigNumber)
      const shares = new BigNumber(amount)
        .multipliedBy('1000000000000000000')
        .dividedBy(vault.current_index);
      
      // 3. Update database
      await tx`UPDATE client_vaults SET total_shares = ${shares}`;
      
      return { shares: shares.toString() };
    });
  }
}
```

**What you add:**
- âœ… Complex calculations (BigNumber)
- âœ… Transaction management
- âœ… Business rules enforcement
- âœ… Error handling
- âœ… Logging

### 3. Service Layer (Orchestration)

**Location:** `packages/core/src/services/`

**You write this!** Coordinates multiple repositories.

```typescript
export class DepositService {
  constructor(
    private vaultRepo: VaultRepository,
    private userRepo: UserRepository,
    private depositRepo: DepositRepository
  ) {}

  async processDeposit(params) {
    // Orchestrate multiple repos
    const user = await this.userRepo.getOrCreate(params.userId);
    const result = await this.vaultRepo.depositWithShareMinting(...);
    await this.depositRepo.createTransaction(...);
    
    return result;
  }
}
```

**What you add:**
- âœ… Multi-repository workflows
- âœ… External API calls (Privy, AAVE)
- âœ… Event emission
- âœ… Complex validation

### 4. API Layer (HTTP Handlers)

**Location:** `apps/web/app/api/`

**You write this!** HTTP request/response handling.

```typescript
// Next.js API Route
export async function POST(req: NextRequest) {
  const body = await req.json();
  
  // Initialize services
  const depositService = new DepositService(vaultRepo, userRepo, depositRepo);
  
  // Process request
  const result = await depositService.processDeposit(body);
  
  return NextResponse.json(result);
}
```

### 5. Frontend Hooks (React)

**Location:** `apps/web/hooks/`

```typescript
export function useUserBalance(userId: string) {
  const { data } = useSWR(`/api/users/${userId}/balance`, fetcher);
  
  return {
    balance: formatBalance(data?.effectiveBalance),
    yieldEarned: formatBalance(data?.yieldEarned),
    loading: !data
  };
}
```

### 6. React Components

```typescript
export function UserBalance({ userId }: Props) {
  const { balance, yieldEarned } = useUserBalance(userId);
  
  return <div>Balance: ${balance}</div>;
}
```

## ğŸ¯ Key Patterns

### Pattern 1: Type Flow (Top to Bottom)

```typescript
PostgreSQL Table
  â†“ SQLC generates
ClientVault interface
  â†“ Repository uses
VaultRepository.getVault() returns ClientVault
  â†“ Service uses
DepositService processes ClientVault
  â†“ API uses
API route returns JSON
  â†“ Frontend uses
React component displays data
```

**Type safety at every layer!** âœ…

### Pattern 2: Transaction Pattern

```typescript
async depositWithShareMinting() {
  return await this.sql.begin(async (tx) => {
    // All queries use `tx` instead of `this.sql`
    const vault = await tx`SELECT ...`;
    await tx`UPDATE ...`;
    await tx`INSERT ...`;
    
    // All succeed or all rollback
  });
}
```

### Pattern 3: BigNumber Pattern

```typescript
// Always use BigNumber for NUMERIC(78,0)
const currentIndex = new BigNumber(vault.currentIndex);
const amount = new BigNumber(params.amount);
const ONE_E18 = new BigNumber('1000000000000000000');

// Precise calculations
const shares = amount
  .multipliedBy(ONE_E18)
  .dividedBy(currentIndex)
  .integerValue(BigNumber.ROUND_DOWN);

// Convert to string for database
await sql`INSERT INTO ... VALUES (${shares.toString()})`;
```

### Pattern 4: Error Handling Pattern

```typescript
class VaultRepository {
  async getVault(id: string): Promise<ClientVault> {
    const vaults = await this.sql`SELECT * FROM client_vaults WHERE id = ${id}`;
    
    if (vaults.length === 0) {
      throw new VaultNotFoundError(id);
    }
    
    return vaults[0] as ClientVault;
  }
}
```

## ğŸ“‚ File Structure

```
packages/
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ gen/                         âœ… SQLC (don't edit)
â”‚   â”‚   â”‚   â”œâ”€â”€ models.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ client_sql.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ vault_sql.ts
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ repositories/                âœ… Your code
â”‚   â”‚       â”œâ”€â”€ vault.repository.ts      â† Share minting logic
â”‚   â”‚       â”œâ”€â”€ client.repository.ts
â”‚   â”‚       â”œâ”€â”€ deposit.repository.ts
â”‚   â”‚       â””â”€â”€ user.repository.ts
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ core/
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ services/                    âœ… Your code
â”‚           â”œâ”€â”€ deposit.service.ts       â† Orchestrates repos
â”‚           â”œâ”€â”€ withdrawal.service.ts
â”‚           â””â”€â”€ yield.service.ts

apps/
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ api/                        âœ… Your code
â”‚   â”‚       â”œâ”€â”€ deposits/route.ts       â† HTTP handlers
â”‚   â”‚       â””â”€â”€ users/[id]/balance/route.ts
â”‚   â”œâ”€â”€ hooks/                          âœ… Your code
â”‚   â”‚   â”œâ”€â”€ useUserBalance.ts           â† React data fetching
â”‚   â”‚   â””â”€â”€ useDeposit.ts
â”‚   â””â”€â”€ components/                     âœ… Your code
â”‚       â””â”€â”€ UserBalance.tsx             â† UI components
```

## ğŸ”„ Development Workflow

### 1. Define SQL Queries

```sql
-- database/queries/vault.sql

-- name: GetClientVaultByToken :one
SELECT * FROM client_vaults
WHERE client_id = $1 AND chain = $2 AND token_address = $3;

-- name: UpdateVaultIndex :exec
UPDATE client_vaults
SET current_index = $1
WHERE id = $2;
```

### 2. Generate TypeScript

```bash
make sqlc-generate
```

This creates `packages/database/src/gen/vault_sql.ts` with type-safe functions.

### 3. Use in Repository

```typescript
import { getClientVaultByToken } from '../gen/vault_sql';

class VaultRepository {
  async getVault(clientId: string, chain: string, token: string) {
    return await getClientVaultByToken(this.sql, {
      clientId,
      chain,
      tokenAddress: token
    });
  }
}
```

### 4. Use in Service

```typescript
class DepositService {
  async processDeposit() {
    const vault = await this.vaultRepo.getVault(...);
    // Use vault data
  }
}
```

### 5. Expose via API

```typescript
export async function GET(req: NextRequest) {
  const vault = await depositService.getVault(...);
  return NextResponse.json(vault);
}
```

### 6. Consume in React

```typescript
const { data } = useSWR('/api/vaults/...');
```

## âœ… Benefits

1. **Type Safety** - Compile-time errors, not runtime crashes
2. **Clean Architecture** - Clear separation of concerns
3. **Performance** - No ORM overhead, direct SQL
4. **Maintainability** - SQLC generates boilerplate
5. **Testability** - Easy to mock repositories
6. **Scalability** - BigNumber precision, transactions

## ğŸš€ Getting Started

1. **Install dependencies:**
   ```bash
   cd packages/database
   pnpm add postgres bignumber.js
   ```

2. **Generate SQLC code:**
   ```bash
   make sqlc-generate
   ```

3. **Create your first repository:**
   - See `src/repositories/vault.repository.ts` for example

4. **Create a service:**
   - See example in README.md

5. **Add API route:**
   - See Next.js example in README.md

6. **Build React component:**
   - Use hooks to fetch data

---

**This pattern is production-proven by Cleverse!** ğŸ‰
